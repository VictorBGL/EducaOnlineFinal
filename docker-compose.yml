services:
  rabbitmq:
    image: rabbitmq:3-management
    container_name: educaonline-rabbitmq
    hostname: educa-rabbit
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - educaonline-network
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    image: fermotta/educaonline-frontend:latest
    container_name: educaonline-frontend
    ports:
      - "4200:80"
    depends_on:
      - bff
    networks:
      - educaonline-network
    restart: unless-stopped

  identidade-api:
    image: fermotta/educaonline-identidade-api:latest
    container_name: educaonline-identidade-api
    ports:
      - "5001:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Data Source=identidade.db
      - MessageQueueConnection__MessageBus=host=rabbitmq:5672;username=guest;password=guest;publisherConfirms=true;timeout=30
      - JwtSettings__Segredo=EDUCAONLINE_SECRET_KEY_SUPER_SEGURA_2024_DEVXPERT
      - JwtSettings__HorasParaExpirar=24
      - JwtSettings__Emissor=EducaOnline
      - JwtSettings__Audiencia=https://localhost
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - educaonline-network
    restart: unless-stopped

  conteudo-api:
    image: fermotta/educaonline-conteudo-api:latest
    container_name: educaonline-conteudo-api
    ports:
      - "5002:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Data Source=conteudo.db
      - MessageQueueConnection__MessageBus=host=rabbitmq:5672;username=guest;password=guest;publisherConfirms=true;timeout=30
      - JwtSettings__Segredo=EDUCAONLINE_SECRET_KEY_SUPER_SEGURA_2024_DEVXPERT
      - JwtSettings__HorasParaExpirar=24
      - JwtSettings__Emissor=EducaOnline
      - JwtSettings__Audiencia=https://localhost
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - educaonline-network
    restart: unless-stopped

  aluno-api:
    image: fermotta/educaonline-aluno-api:latest
    container_name: educaonline-aluno-api
    ports:
      - "5003:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Data Source=aluno.db
      - MessageQueueConnection__MessageBus=host=rabbitmq:5672;username=guest;password=guest;publisherConfirms=true;timeout=30
      - JwtSettings__Segredo=EDUCAONLINE_SECRET_KEY_SUPER_SEGURA_2024_DEVXPERT
      - JwtSettings__HorasParaExpirar=24
      - JwtSettings__Emissor=EducaOnline
      - JwtSettings__Audiencia=https://localhost
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - educaonline-network
    restart: unless-stopped

  pedidos-api:
    image: fermotta/educaonline-pedidos-api:latest
    container_name: educaonline-pedidos-api
    ports:
      - "5004:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Data Source=pedidos.db
      - MessageQueueConnection__MessageBus=host=rabbitmq:5672;username=guest;password=guest;publisherConfirms=true;timeout=30
      - JwtSettings__Segredo=EDUCAONLINE_SECRET_KEY_SUPER_SEGURA_2024_DEVXPERT
      - JwtSettings__HorasParaExpirar=24
      - JwtSettings__Emissor=EducaOnline
      - JwtSettings__Audiencia=https://localhost
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - educaonline-network
    restart: unless-stopped

  financeiro-api:
    image: fermotta/educaonline-financeiro-api:latest
    container_name: educaonline-financeiro-api
    ports:
      - "5005:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Data Source=financeiro.db
      - MessageQueueConnection__MessageBus=host=rabbitmq:5672;username=guest;password=guest;publisherConfirms=true;timeout=30
      - JwtSettings__Segredo=EDUCAONLINE_SECRET_KEY_SUPER_SEGURA_2024_DEVXPERT
      - JwtSettings__HorasParaExpirar=24
      - JwtSettings__Emissor=EducaOnline
      - JwtSettings__Audiencia=https://localhost
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - educaonline-network
    restart: unless-stopped

  bff:
    image: fermotta/educaonline-bff:latest
    container_name: educaonline-bff
    ports:
      - "5000:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - Services__IdentidadeUrl=http://identidade-api:8080
      - Services__ConteudoUrl=http://conteudo-api:8080
      - Services__AlunoUrl=http://aluno-api:8080
      - Services__PedidosUrl=http://pedidos-api:8080
      - Services__FinanceiroUrl=http://financeiro-api:8080
      - MessageQueueConnection__MessageBus=host=rabbitmq:5672;username=guest;password=guest;publisherConfirms=true;timeout=30
      - JwtSettings__Segredo=EDUCAONLINE_SECRET_KEY_SUPER_SEGURA_2024_DEVXPERT
      - JwtSettings__HorasParaExpirar=24
      - JwtSettings__Emissor=EducaOnline
      - JwtSettings__Audiencia=https://localhost
    depends_on:
      - identidade-api
      - conteudo-api
      - aluno-api
      - pedidos-api
      - financeiro-api
    networks:
      - educaonline-network
    restart: unless-stopped
volumes:
  rabbitmq_data:
    driver: local
networks:
  educaonline-network:
    driver: bridge